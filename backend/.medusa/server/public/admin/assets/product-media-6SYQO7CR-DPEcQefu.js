import{E as G,U as K}from"./chunk-ZC6J4336-BF4CgWVr.js";import"./chunk-QRQHBXSL-D57wry5N.js";import{r as f,R as W,S as O,j as e,a9 as H,b as z,ab as q,ac as X,z as Y,V as B,s as $,B as N,L,c as J,I as S,an as Q,T as A,W as F,m as k,al as Z,ao as ee,ap as se}from"./index-Bq0Gzu_3.js";import{K as te}from"./chunk-CEEYZHMN-CL6q0Lsw.js";import{R as j,u as ie}from"./chunk-MDIOSTKB-CScRFmr1.js";import{T as ae}from"./trash-WzBoCVyR.js";import{T as U}from"./thumbnail-badge-Bytg7GJD.js";import{T as re}from"./triangle-left-mini-C5FnHW24.js";import{A as ne}from"./index-oY_2eMsb.js";import{m as le}from"./proxy-Bw0yEXBv.js";import{u as oe}from"./use-prompt-DKUUp42P.js";import{C as w}from"./command-bar-DD70Q2dm.js";import"./chunk-TYTNUPXB-D-YpmrFw.js";import"./chunk-6GU6IDUA-CDc7wW5L.js";import"./prompt-B670l_cz.js";import"./index-C99Xhc7P.js";var de=({media:i,selection:s,onCheckedChange:a})=>e.jsx("div",{className:"bg-ui-bg-subtle size-full overflow-auto",children:e.jsx("div",{className:"grid h-fit auto-rows-auto grid-cols-4 gap-6 p-6",children:i.map(t=>e.jsx(ce,{onCheckedChange:a(t.id),checked:!!s[t.id],media:t},t.field_id))})}),ce=({media:i,checked:s,onCheckedChange:a})=>{const[t,n]=f.useState(!0),{t:c}=z(),u=f.useCallback(()=>{a(!s)},[s,a]);return e.jsxs("button",{type:"button",onClick:u,className:"shadow-elevation-card-rest hover:shadow-elevation-card-hover focus-visible:shadow-borders-focus bg-ui-bg-subtle-hover group relative aspect-square h-auto max-w-full overflow-hidden rounded-lg outline-none",children:[i.isThumbnail&&e.jsx("div",{className:"absolute left-2 top-2",children:e.jsx(F,{content:c("products.media.thumbnailTooltip"),children:e.jsx(U,{})})}),e.jsx("div",{className:k("transition-fg absolute right-2 top-2 opacity-0 group-focus-within:opacity-100 group-hover:opacity-100 group-focus:opacity-100",{"opacity-100":s}),children:e.jsx("div",{className:k("group relative inline-flex h-4 w-4 items-center justify-center outline-none "),children:e.jsx("div",{className:k("text-ui-fg-on-inverted bg-ui-bg-component shadow-borders-base [&_path]:shadow-details-contrast-on-bg-interactive group-disabled:text-ui-fg-disabled group-disabled:!bg-ui-bg-disabled group-disabled:!shadow-borders-base transition-fg h-[14px] w-[14px] rounded-[3px]",{"bg-ui-bg-interactive group-hover:bg-ui-bg-interactive shadow-borders-interactive-with-shadow":s}),children:s&&e.jsx("div",{className:"absolute inset-0",children:e.jsx(ee,{})})})})}),e.jsx(ne,{children:t&&e.jsx(le.div,{initial:{opacity:1},animate:{opacity:1},exit:{opacity:0,transition:{duration:.5}},className:"bg-ui-bg-subtle-hover absolute inset-0 flex items-center justify-center",children:e.jsx(se,{className:"text-ui-fg-subtle animate-spin"})})}),e.jsx("img",{src:i.url,onLoad:()=>n(!1),alt:"",className:"size-full object-cover object-center"})]})},ue=({product:i})=>{const[s,a]=f.useState({}),{t}=z(),{handleSuccess:n}=ie(),c=q({defaultValues:{media:me(i.images,i.thumbnail)},resolver:X(G)}),{fields:u,append:r,remove:o,update:p}=Y({name:"media",control:c.control,keyName:"field_id"}),{mutateAsync:m,isPending:v}=B(i.id),I=c.handleSubmit(async({media:x})=>{var E;const d=x.map((h,T)=>({file:h.file,index:T})).filter(h=>!!h.file);let b=[];if(d.length){const{files:h}=await $.admin.upload.create({files:d.map(T=>T.file)}).catch(()=>(c.setError("media",{type:"invalid_file",message:t("products.media.failedToUpload")}),{files:[]}));b=h}const g=x.map((h,T)=>{var _;const V=d.findIndex(D=>D.index===T);return V>-1?{...h,url:(_=b[V])==null?void 0:_.url}:h}),R=(E=g.find(h=>h.isThumbnail))==null?void 0:E.url;await m({images:g.map(h=>({url:h.url})),thumbnail:R||""},{onSuccess:()=>{n()}})}),M=f.useCallback(x=>d=>{if(d)a(b=>({...b,[x]:!0}));else{const{[x]:b,...g}=s;a(g)}},[s]),C=()=>{const d=Object.keys(s).map(b=>u.findIndex(g=>g.id===b));o(d),a({})},l=()=>{const x=Object.keys(s);if(!x.length)return;const d=u.findIndex(g=>g.isThumbnail);d>-1&&p(d,{...u[d],isThumbnail:!1});const b=u.findIndex(g=>g.id===x[0]);p(b,{...u[b],isThumbnail:!0}),a({})},y=Object.keys(s).length;return e.jsx(j.Form,{blockSearch:!0,form:c,children:e.jsxs(te,{className:"flex size-full flex-col overflow-hidden",onSubmit:I,children:[e.jsx(j.Header,{children:e.jsx("div",{className:"flex items-center justify-end gap-x-2",children:e.jsx(N,{variant:"secondary",size:"small",asChild:!0,children:e.jsx(L,{to:{pathname:".",search:void 0},children:t("products.media.galleryLabel")})})})}),e.jsx(j.Body,{className:"flex flex-col overflow-hidden",children:e.jsxs("div",{className:"flex size-full flex-col-reverse lg:grid lg:grid-cols-[1fr_560px]",children:[e.jsx(de,{media:u,onCheckedChange:M,selection:s}),e.jsx("div",{className:"bg-ui-bg-base overflow-auto border-b px-6 py-4 lg:border-b-0 lg:border-l",children:e.jsx(K,{form:c,append:r})})]})}),e.jsx(w,{open:!!y,children:e.jsxs(w.Bar,{children:[e.jsx(w.Value,{children:t("general.countSelected",{count:y})}),e.jsx(w.Seperator,{}),y===1&&e.jsxs(f.Fragment,{children:[e.jsx(w.Command,{action:l,label:t("products.media.makeThumbnail"),shortcut:"t"}),e.jsx(w.Seperator,{})]}),e.jsx(w.Command,{action:C,label:t("actions.delete"),shortcut:"d"})]})}),e.jsx(j.Footer,{children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(j.Close,{asChild:!0,children:e.jsx(N,{variant:"secondary",size:"small",children:t("actions.cancel")})}),e.jsx(N,{size:"small",type:"submit",isLoading:v,children:t("actions.save")})]})})]})})},me=(i,s)=>{const a=(i==null?void 0:i.map(t=>({id:t.id,url:t.url,isThumbnail:t.url===s,file:null})))||[];if(s&&!a.some(t=>t.url===s)){const t=Math.random().toString(36).substring(7);a.unshift({id:t,url:s,isThumbnail:!0,file:null})}return a},he=({product:i})=>{const{state:s}=J(),[a,t]=f.useState((s==null?void 0:s.curr)||0),{t:n}=z(),c=oe(),{mutateAsync:u,isLoading:r}=B(i.id),o=pe(i.images,i.thumbnail),p=f.useCallback(()=>{r||t(l=>(l+1)%o.length)},[o,r]),m=f.useCallback(()=>{r||t(l=>(l-1+o.length)%o.length)},[o,r]),v=f.useCallback(l=>{r||t(l)},[r]),I=()=>{if(r)return;const l=document.createElement("a");l.href=o[a].url,l.download="image",l.target="_blank",l.click()},M=async()=>{const l=o[a];if(!await c({title:n("general.areYouSure"),description:l.isThumbnail?n("products.media.deleteWarningWithThumbnail",{count:1}):n("products.media.deleteWarning",{count:1}),confirmText:n("actions.delete"),cancelText:n("actions.cancel")}))return;const x=i.images.filter(d=>d.id!==l.id).map(d=>({url:d.url}));a===o.length-1&&t(d=>d-1),await u({images:x,thumbnail:l.isThumbnail?"":void 0})};f.useEffect(()=>{const l=y=>{y.key==="ArrowRight"?p():y.key==="ArrowLeft"&&m()};return document.addEventListener("keydown",l),()=>{document.removeEventListener("keydown",l)}},[p,m]);const C=!o.length;return e.jsxs("div",{className:"flex size-full flex-col overflow-hidden",children:[e.jsx(j.Header,{children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsxs(S,{size:"small",type:"button",onClick:M,disabled:C,children:[e.jsx(ae,{}),e.jsx("span",{className:"sr-only",children:n("products.media.deleteImageLabel")})]}),e.jsxs(S,{size:"small",type:"button",onClick:I,disabled:C,children:[e.jsx(Q,{}),e.jsx("span",{className:"sr-only",children:n("products.media.downloadImageLabel")})]}),e.jsx(N,{variant:"secondary",size:"small",asChild:!0,children:e.jsx(L,{to:{pathname:".",search:"view=edit"},children:n("actions.edit")})})]})}),e.jsxs(j.Body,{className:"flex flex-col overflow-hidden",children:[e.jsx(xe,{curr:a,media:o}),e.jsx(fe,{curr:a,media:o,prev:m,next:p,goTo:v})]})]})},xe=({media:i,curr:s})=>{const{t:a}=z();return i.length===0?e.jsxs("div",{className:"bg-ui-bg-subtle flex size-full flex-col items-center justify-center gap-y-4 pb-8 pt-6",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx(A,{size:"small",leading:"compact",weight:"plus",className:"text-ui-fg-subtle",children:a("products.media.emptyState.header")}),e.jsx(A,{size:"small",className:"text-ui-fg-muted",children:a("products.media.emptyState.description")})]}),e.jsx(N,{size:"small",variant:"secondary",asChild:!0,children:e.jsx(L,{to:"?view=edit",children:a("products.media.emptyState.action")})})]}):e.jsx("div",{className:"bg-ui-bg-subtle relative size-full overflow-hidden",children:e.jsx("div",{className:"flex size-full items-center justify-center p-6",children:e.jsxs("div",{className:"relative h-full w-fit",children:[i[s].isThumbnail&&e.jsx("div",{className:"absolute left-2 top-2",children:e.jsx(F,{content:a("products.media.thumbnailTooltip"),children:e.jsx(U,{})})}),e.jsx("img",{src:i[s].url,alt:"",className:"object-fit shadow-elevation-card-rest size-full rounded-xl object-contain"})]})})})},P=8,fe=({media:i,curr:s,prev:a,next:t,goTo:n})=>{if(!i.length)return null;const u=((r,o)=>{if(r.length<=P)return r;const p=Math.floor(P/2),m=(o-p+r.length)%r.length,v=(m+P)%r.length;return v<m?[...r.slice(m),...r.slice(0,v)]:r.slice(m,v)})(i,s);return e.jsxs("div",{className:"flex shrink-0 items-center justify-center gap-x-2 border-t p-3",children:[e.jsx(S,{size:"small",variant:"transparent",className:"text-ui-fg-muted",type:"button",onClick:a,children:e.jsx(re,{})}),e.jsx("div",{className:"flex items-center gap-x-2",children:u.map(r=>{const o=r.id===i[s].id,p=i.findIndex(m=>m.id===r.id);return e.jsx("button",{type:"button",onClick:()=>n(p),className:k("transition-fg size-7 overflow-hidden rounded-[4px] outline-none",{"shadow-borders-focus":o}),children:e.jsx("img",{src:r.url,alt:"",className:"size-full object-cover"})},r.id)})}),e.jsx(S,{size:"small",variant:"transparent",className:"text-ui-fg-muted",type:"button",onClick:t,children:e.jsx(Z,{})})]})},pe=(i,s)=>{const a=(i==null?void 0:i.map(t=>({id:t.id,url:t.url,isThumbnail:t.url===s})))||[];return s&&!a.some(t=>t.isThumbnail)&&a.unshift({id:"thumbnail_only",url:s,isThumbnail:!0}),a},be=f.createContext(null),ge=i=>i.get("view")==="edit"?"edit":"gallery",je=({product:i})=>{const[s,a]=H(),t=ge(s),n=c=>()=>{a({view:c})};return e.jsx(be.Provider,{value:{goToGallery:n("gallery"),goToEdit:n("edit")},children:ve(t,i)})},ve=(i,s)=>{switch(i){case"gallery":return e.jsx(he,{product:s});case"edit":return e.jsx(ue,{product:s})}},Be=()=>{const{id:i}=W(),{product:s,isLoading:a,isError:t,error:n}=O(i),c=!a&&s;if(t)throw n;return e.jsx(j,{children:c&&e.jsx(je,{product:s})})};export{Be as Component};
